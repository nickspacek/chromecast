<!DOCTYPE html>
<html lang="en" data-cast-api-enabled="true">
	<head>
		<title>Chromecast Test</title>
		<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0-rc1/css/bootstrap.min.css" rel="stylesheet" />
		<link href="style/jquery.cast-receiver-list.css" rel="stylesheet" />
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0-rc1/js/bootstrap.min.js"></script>
		<script src="script/jquery.cast-receiver-list.js"></script>
		<script src="script/crafty.js"></script>

<script type="text/javascript">
$(function () {
	var appId = 'ae241d56-0944-42ed-b6eb-06c314f5b5a0';
	var cast_api, cv_activity;

	$('.controls').hide();

	$('.stop-button').click(function (e) {
		e.preventDefault();

		if (cast_api && cv_activity) {
			cast_api.stopActivity(cv_activity.activityId, onStopResult);
			$('.stop-button').attr('disabled', true);
		}
	});
	
	var joinButtons = $('.join-button').click(function (e) {
		e.preventDefault();
		if (cast_api && cv_activity) {
			sendMessage('join', { name: 'Nick' }, function (result) {
				if (result.status === 'success') {
					joinButtons.attr('disabled', true);
				}
			});
		}
	});

	var onStopResult = function (result) {
		if (result.status === 'stopped') {
			cv_activity = null;
			$('.controls').hide();
		}
		else {
			// unable to stop
			$('.stop-button').removeAttr('disabled');
		}
	};

	if (typeof cast !== 'undefined' && cast.isAvailable) {
		initializeApi();
	} else {
		window.addEventListener("message", function(event) {
			if (event.source == window && event.data && event.data.source === "CastApi" && event.data.event === "Hello") {
				initializeApi();
			}
		});
	}

	var initializeApi = function() {
		cast_api = new cast.Api();
		cast_api.addReceiverListener(appId, onReceiverList);
		$('#receivers').receiverList({
			api: cast_api,
			appId: appId,
			click: function (e, receiver) {
				doLaunch(receiver);
			}
		});
	};

	var theReceivers = {};
	var onReceiverList = function(receivers) {
		receivers.forEach(function (receiver) {
			theReceivers[receiver.id] = receiver;
		});
	};

	var doLaunch = function(receiver) {
		var request = new cast.LaunchRequest(appId, receiver);
		request.parameters = "v=abcdefg";
	
		request.description = new cast.LaunchDescription();
		request.description.text = "My Cat Video";
		request.description.url = "...";
		cast_api.launch(request, onLaunch);
	};

	var onLaunch = function(activity) {
		if (activity.status === "running") {
			updateCurrentActivity(activity);
		} else if (activity.status === "error") {
			cv_activity = null;
		}
	};

	var updateCurrentActivity = function(activity) {
		cv_activity = activity;
		$('.stop-button').removeAttr('disabled');
		$('.controls').show();
	};

	$('#messager').keyup(function (e) {
		if (e.keyCode == 13) {
			sendMessage('text', $(this).val());
			$(this).val('');
		}
	});
	
	var sendMessage = function (command, attrs, callback) {
		cast_api.sendMessage(cv_activity.activityId, 'ca.spacek.chromecast.test.beluga',
			$.extend({ command: command }, attrs), callback);
	};
});
</script>
	</head>
	<body>
		<div class="container">
			<h1>Test!</h1>
			<button class="stop-button btn btn-danger" disabled>Stop Casting</button>
			<h3>Receivers</h3>
			<div class="row">
				<div id="receivers" class="col-6">
				</div>
			</div>

			<div class="controls">
				Connected
				<button type="button" class="btn btn-primary join-button">Join Game</button>
			</div>
		</div>
	</body>
</html>
