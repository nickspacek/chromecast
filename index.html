<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Chromecast Test</title>
		<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0-rc1/css/bootstrap.min.css" rel="stylesheet">
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0-rc1/js/bootstrap.min.js"></script>
		<script src="https://www.gstatic.com/cast/js/receiver/1.0/cast_receiver.js"></script>

		<script type="text/javascript">
function Game() {
	this.players = [];
	this.maxPlayers = 10;
	this.currentPlayer = null;
	
	this.channelHandler = new cast.receiver.ChannelHandler('ca.spacek.chromecast.test.beluga');
	this.channelHandler.addEventListener(cast.receiver.Channel.EventType.MESSAGE, this.onMessage.bind(this));
	this.channelHandler.addEventListener(cast.receiver.Channel.EventType.OPEN, this.onOpen.bind(this));
	this.channelHandler.addEventListener(cast.receiver.Channel.EventType.CLOSE, this.onClose.bind(this));
}

Game.prototype = {
	onMessage: function (e) {
		var message = e.message;
		var channel = e.target;
		console.debug('message received', JSON.stringify(message));
		
		if (message.command === 'join') {
			this.onJoin(channel, message);
		}
		else if (message.command === 'leave') {
			this.onLeave(channel);
		}
		else if (message.command === 'move') {
			this.onMove(channel, message);
		}
		else if (message.command === 'say') {
			this.onSay(channel, message);
		}
		else {
			cast.log.error('Invalid message command: ' + message.command);
		}
	},
	onOpen: function (e) {
		console.debug('channel opened, total number of channels: ' + this.channelHandler.getChannels().length);
	},
	onClose: function (e) {
		var count = this.channelHandler.getChannels().length;
		console.debug('channel closed, total number of channels: ' + count);
		if (count == 0) {
			window.close();
		}
	},
	onJoin: function (channel, message) {
		if (this.players.length >= 10) {
			console.debug('game is already full!');
			// TODO send error
			return;
		}
		var existingPlayer = this.findPlayer(channel);
		if (existingPlayer) {
			console.debug('player has already joined (connected as ' + existingPlayer.name + '!');
			// TODO send error
			return;
		}
		
		var player = this.createPlayer(channel, message);
		console.debug(player.name + ' has joined the game!');
		this.players.push(player);
	},
	createPlayer: function (channel, message) {
		return {
			name: message.name,
			channel: channel
		};
	},
	onSay: function (channel, message) {
		var player = this.findPlayer(channel);
		if (!player) {
			console.debug("someone tried to say something but they haven't joined the game!");
			// TODO send error
			return;
		}
		
		this.broadcast({
			event: 'say',
			player: player.name,
			content: message.content
		});
	},
	findPlayer: function (channel) {
		var existingPlayer = null;
		this.players.forEach(function (player) {
			if (player.channel == channel) {
				existingPlayer = player;
			}
		});
		return existingPlayer;
	},
	broadcast: function (message) {
		this.channelHandler.getChannels().forEach(function (channel) {
			channel.send(message);
		});
	},
	onLeave: function (channel) {
		console.debug('someone left!');
	},
	onMove: function (channel, message) {
		console.debug('moving');
	}
};
		
$(function () {
var appId = 'ae241d56-0944-42ed-b6eb-06c314f5b5a0';
var receiver = new cast.receiver.Receiver(appId, [ 'ca.spacek.chromecast.test.beluga' ], '', 5);

var game = new Game();
game.channelHandler.addChannelFactory(receiver.createChannelFactory('ca.spacek.chromecast.test.beluga'));
receiver.start();
});
	</script>
	</head>
	<body>
		<div class="container">
			<h1>Test!</h1>
			<ol id="messages">
			</ol>
			<h3>Current image</h3>
			<img src="image/no-image.png" alt="" />
		</div>
	</body>
</html>
