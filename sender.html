<!DOCTYPE html>
<html lang="en" data-cast-api-enabled="true">
	<head>
		<title>Chromecast Test</title>
		<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0-rc1/css/bootstrap.min.css" rel="stylesheet">
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0-rc1/js/bootstrap.min.js"></script>

<script type="text/javascript">
$(function () {

	//	var receiver = new cast.receiver.Receiver('ae241d56-0944-42ed-b6eb-06c314f5b5a0', [ 'ca.spacek.chromecase.test.aardvark' ], '', 5);
	var appId = 'ae241d56-0944-42ed-b6eb-06c314f5b5a0';
	var cast_api, cv_activity;

	$('.stop-button').click(function (e) {
		e.preventDefault();

		if (cast_api && cv_activity) {
			cast_api.stopActivity(cv_activity.id, onStopResult);
			$('.stop-button').attr('disabled', true);
		}
	});

	var onStopResult = function (result) {
		if (result.status === 'stopped') {
			cv_activity = null;
		}
		else {
			$('.stop-button').attr('disabled', true);
		}
	};

	if (typeof cast !== 'undefined' && cast.isAvailable) {
		// Cast is known to be available
		initializeApi();
	} else {
		// Wait for API to post a message to us
		window.addEventListener("message", function(event) {
			if (event.source == window && event.data && event.data.source == "CastApi" && event.data.event == "Hello") {
				initializeApi();
			}
		});
	}

	var initializeApi = function() {
		cast_api = new cast.Api();
		cast_api.addReceiverListener(appId, onReceiverList);
	};

	var theReceivers = {};
	var onReceiverList = function(receivers) {
		receivers.forEach(function (receiver) {
			theReceivers[receiver.id] = receiver;
		});

		var list = $('#receivers').on('click', 'button', function (e) {
		 	e.preventDefault();

			var receiverId = $(this).closest('li').attr('data-id');
			doLaunch(theReceivers[receiverId]);	
		});

		list.append(receivers.map(function (item) {
	 	var listItem = $('<li class="receiver" />')
			.attr('data-id', item.id);

		var element = $('<div />').appendTo(listItem);
		$('<span />').text(item.name).appendTo(element);
		var launcher = $('<button class="btn btn-primary" type="button" />')
			.text('Launch')
			.appendTo(element);

		var info = $('<div class="receiver-info" />').appendTo(listItem);
		$('<span />').text(item.id).appendTo(info);
		$('<span />').text(item.ipAddress).appendTo(info);
		$('<span />').text(item.isTabProjected).appendTo(info);
		
	 	return listItem;
		}));
	};

	var doLaunch = function(receiver) {
		var request = new cast.LaunchRequest(appId, receiver);
		request.parameters = "v=abcdefg";
	
		request.description = new cast.LaunchDescription();
		request.description.text = "My Cat Video";
		request.description.url = "...";
		cast_api.launch(request, onLaunch);
	};

	var onLaunch = function(activity) {
		console.debug(activity);
		if (activity.status == "running") {
			cv_activity = activity;
			$('.stop-button').removeAttr('disabled');
		} else if (activity.status == "error") {
			cv_activity = null;
		}
	};

	$('#messager').keyup(function (e) {
		if (e.keyCode == 13) {
			cast_api.sendMessage(cv_activity.id, 'ca.spacek.chromecast.test.aardvark', { test: 'blarg', type: 'hello' }, onMessageResult);
			$(this).val('');
		}
	});

	var onMessageResult = function (result) {
		console.debug(result);
	};
});
</script>
	</head>
	<body>
		<div class="container">
			<h1>Test!</h1>
			<button class="stop-button btn btn-danger" disabled>Stop Casting</button>
			<ol id="receivers"></ol>
			<input type="text" id="messager" />
		</div>
	</body>
</html>
